<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  {% load static %}
  <link rel="stylesheet" href="{% static '/css/qbe.css' %}">
  <link rel="stylesheet" href="{% static '/css/navbar.css' %}">
  <title>QBE</title>
</head>

<body>
  {% include 'navbar.html' %}
  <div id="container">
    <h4 id="qbe">QBE(Query-by-Frame)</h4>
    <div class="row" id="content">
      <!--searchBox-->
      <div class="col-6" id="searchBox">
        <form id="myForm" novalidate action="getQuery" method="POST">{% csrf_token %}
          <div class="form-group row">
            <div class="col-sm-2"></div>
            <label class="col-sm-3 label">Year</label>
            <div class="col-sm-7">
              <select class="form-control" name="year" id="year" onchange="preview()">
                <option value="2018">2018</option>
              </select>
            </div>
            <div class="col-sm-1"></div>
          </div>
          <div class="form-group row">
            <div class="col-sm-2"></div>
            <label class="col-sm-3 label">Month</label>
            <div class="col-sm-7">
              <select class="form-control" name="month" id="month" onchange="preview(); changeDate()">
              </select>
            </div>
            <div class="col-sm-1"></div>
          </div>
          <div class="form-group row">
            <div class="col-sm-2"></div>
            <label class="col-sm-3 label">Day</label>
            <div class="col-sm-7">
              <select class="form-control" name="day" id="day" onchange="preview()">
              </select>
            </div>
            <div class="col-sm-1"></div>
          </div>
          <div class="form-group row">
            <div class="col-sm-2"></div>
            <label class="col-sm-3 label">Hour</label>
            <div class="col-sm-7">
              <select class="form-control" name="hour" id="hour" onchange="preview()">
              </select>
            </div>
            <div class="col-sm-1"></div>
          </div>
          <div class="form-group row">
            <div class="col-sm-2"></div>
            <label class="col-sm-3 label">Dataset</label>
            <div class="col-sm-7">
              <input type="radio" name="dataset" id="level" value="level" checked onchange="preview()">
              <label for="level"> level </label>
              <span style="margin-left: 1em;margin-right: 1em;"> </span>
              <input type="radio" name="dataset" id="original" value="original" onchange="preview()">
              <label for="original"> original </label>
            </div>
            <div class="col-sm-1"></div>
          </div>
          <div class="form-group row" id="contrastDiv">
            <div class="col-sm-2"></div>
            <div class="col-sm-3 label">
              <input type="checkbox" name="contrast" id="contrast" onchange="loadContrast()">
            </div>
            <div class="col-sm-7">
              <label for="contrast"> Contrast Enhancement </label>
            </div>
          </div>
        </form>
      </div>
      <!--imageBox-->
      <div class="col-6">
        <div class="row">
          <div class="col-sm-1"></div>
          <div class="col-sm-8 empty" id="imageBox">
            <img src="" alt="" id="image">
          </div>
          <div class="col-sm-3"></div>
        </div>

      </div>

    </div>
    <div class="row">
      <input type="submit" class="btn btn-primary" id="submitBtn" onclick="submitData()" value="SEARCH">
    </div>
  </div>
  <script>
    // check if a year is leap year
    function isLeap(y) {
      if ((y % 4 == 0 && y % 100 != 100) || (y % 100 == 0 && y % 400 == 0)) {
        return true;
      } else {
        return false;
      }
    }

    function getDays() {
      let year = document.getElementById('year').value;
      let monthData = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
      if (isLeap(year)) {
        // there are 29 days in Febuary in leap year
        monthData[1] = 29;
      }
      return monthData;

    }

    function changeDate() {
      let monthData = getDays();
      let month = document.getElementById('month').value;
      let daySelect = document.getElementById('day');
      for (let i = 0; i < monthData[month - 1]; i++) {
        daySelect.innerHTML += `<option value="${i + 1}">${i + 1}</option>`;
      }
    }

    // printOption(): print option in selection box
    function printOption() {
      let year = 0;
      // month
      let monthSelect = document.getElementById('month');
      for (let i = 0; i < 12; i++) {
        monthSelect.innerHTML += `<option value="${i + 1}">${i + 1}</option>`;
      }
      // day
      let daySelect = document.getElementById('day');
      for (let i = 0; i < 31; i++) {
        daySelect.innerHTML += `<option value="${i + 1}">${i + 1}</option>`;
      }
      // hour
      let hourSelect = document.getElementById('hour');
      for (let i = 0; i < 24; i++) {
        hourSelect.innerHTML += `<option value="${i}">${i}</option>`;
      }
    }

    function submitData() {
      document.getElementById('myForm').submit();
    }

    function checkImage(imageSrc) {
      let img = new Image();
      img.onload = () => {
        // console.log("good");
        document.getElementById('imageBox').classList.remove('empty');
        document.getElementById('image').src = imageSrc;
        document.getElementById('submitBtn').disabled = false;
        // console.log(imageSrc);
      };
      img.onerror = () => {
        // console.log("bad");
        document.getElementById('imageBox').classList.add('empty');
        document.getElementById('image').src = "/static/noImage.png";
        document.getElementById('submitBtn').disabled = true;
      };
      img.src = imageSrc;
    }

    function convertName() {
      let year = document.getElementById('year').value;
      let month = document.getElementById('month').value;
      let day = document.getElementById('day').value;
      let hour = document.getElementById('hour').value;
      if (hour < 10) {
        hour = '0' + hour
      }

      let name = "";
      name = year + '-' + month + '-' + day + '-' + hour + '-00.png';
      return name;
    }

    function preview() {
      let path = "";
      // let imageName = document.getElementById('imageName').value;
      // convert image name
      let imageName = convertName();
      if (document.getElementById('level').checked == true) {
        path = "/static/sis/" + imageName;
        document.getElementById('contrast').disabled = true;
        document.getElementById('contrastDiv').classList.add('hideDiv')
        checkImage(path);
      } else {
        document.getElementById('contrast').style.checked = false;
        document.getElementById('contrast').disabled = false;
        document.getElementById('contrastDiv').classList.remove('hideDiv')
        loadContrast();
      }
    }

    function loadContrast() {
      let path = "";
      let imageName = convertName();
      if (document.getElementById('contrast').checked == true) {
        path = "/static/sis_origin_contrast/" + imageName;
      } else {
        path = "/static/sis_origin/" + imageName;
      }
      checkImage(path);
    }


    function promise() {
      return new Promise((resolve, reject) => {
        try {
          const urlSearchParams = new URLSearchParams(window.location.search);
          const params = Object.fromEntries(urlSearchParams.entries());
          if (params.year != null) {
            document.getElementById("year").value = params.year;
          }
          if (params.month != null) {
            document.getElementById("month").value = params.month;
          }
          if (params.day != null) {
            document.getElementById("day").value = params.day;
          }
          if (params.hour != null) {
            document.getElementById("hour").value = params.hour;
          }
          if (params.dataset == "origin") {
            document.getElementsByName('dataset')[1].checked = true;
          } else {
            document.getElementsByName('dataset')[0].checked = true;
          }
          resolve('成功');
        } catch (error) {
          reject('失敗');
        }
      });
    }

    function setParams() {
      const urlSearchParams = new URLSearchParams(window.location.search);
      const params = Object.fromEntries(urlSearchParams.entries());
      promise()
        .then(() => {
          preview()
          if (params.submit == "1") {
            setTimeout(() => {
              document.getElementById('myForm').submit();
            }, 500)
          }
          // console.log(success);
        })
        .catch(fail => {
          console.log(fail);
        });
    }

    printOption();
    setParams();


  </script>


</body>

</html>